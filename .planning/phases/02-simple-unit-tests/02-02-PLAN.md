---
phase: 02-simple-unit-tests
plan: 02
type: execute
wave: 1
depends_on: []
files_modified:
  - tests/test_conversation_emoji.py
autonomous: true

must_haves:
  truths:
    - "Emoji stripping removes all common emoji characters while preserving normal text"
    - "Emoji stripping handles edge cases (empty strings, emoji-only text, multiple consecutive emojis)"
    - "Text-based emoticons like :) are preserved (not stripped)"
    - "Non-ASCII European language text is preserved"
  artifacts:
    - path: "tests/test_conversation_emoji.py"
      provides: "Comprehensive emoji stripping tests"
      min_lines: 120
  key_links:
    - from: "tests/test_conversation_emoji.py"
      to: "custom_components/clawd/conversation.py"
      via: "direct import of strip_emojis and EMOJI_PATTERN"
      pattern: "from custom_components\\.clawd\\.conversation import strip_emojis"
---

<objective>
Create comprehensive unit tests for the emoji stripping functionality in conversation.py.

Purpose: Ensure the strip_emojis function correctly removes emoji characters for TTS output while preserving normal text, punctuation, and text-based emoticons.

Output: test_conversation_emoji.py with parametrized tests covering normal cases, emoji removal, and edge cases.
</objective>

<execution_context>
@~/.claude/get-shit-done/workflows/execute-plan.md
@~/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md

# Phase research
@.planning/phases/02-simple-unit-tests/02-RESEARCH.md

# Source file to test
@custom_components/clawd/conversation.py

# Existing test infrastructure
@tests/conftest.py
</context>

<tasks>

<task type="auto">
  <name>Task 1: Create emoji stripping tests</name>
  <files>tests/test_conversation_emoji.py</files>
  <action>
Create tests/test_conversation_emoji.py with comprehensive parametrized tests for the strip_emojis function.

Import the function and pattern:
```python
from custom_components.clawd.conversation import strip_emojis, EMOJI_PATTERN
```

Structure into test classes by category:

1. **TestEmojiPatternExists** - Verify EMOJI_PATTERN is a compiled regex
   ```python
   import re
   assert isinstance(EMOJI_PATTERN, re.Pattern)
   ```

2. **TestNormalTextPreserved** - Parametrized tests for text that should pass through unchanged:
   - Simple greetings and sentences
   - Numbers and symbols (@#$)
   - Punctuation (comma, period, question mark, exclamation)
   - Quotes (single and double)
   - Parentheses and math expressions

3. **TestTextEmoticonsPreserved** - Parametrized tests for text emoticons that should NOT be stripped:
   - :) :( :D ;)
   - <3 ^_^ o_O
   - Text with emoticons like "Hello :)"

4. **TestCommonEmojisRemoved** - Parametrized tests for emoji characters that SHOULD be stripped:
   - Emoticons range (U+1F600-U+1F64F): grinning face, tears of joy, etc.
   - Symbols & Pictographs (U+1F300-U+1F5FF): sun, fire, etc.
   - Transport symbols (U+1F680-U+1F6FF): rocket, car, etc.
   - Dingbats (U+2702-U+27B0): check mark, star, etc.
   Use Unicode escapes like "\U0001F600" for emoji characters.

5. **TestEdgeCases** - Critical edge cases:
   - Empty string -> empty string
   - Whitespace only -> empty string (strip() effect)
   - Emoji only -> empty string
   - Consecutive emojis removed
   - Emoji at start removed
   - Emoji at end removed
   - Interspersed emojis (note: leaves double spaces, document this)

6. **TestUnicodeHandling** - Non-ASCII text preservation:
   - French, German, Italian, Spanish text unchanged
   - Mixed Unicode and emoji handled correctly
   - Accented characters preserved

7. **TestRealWorldResponses** - Realistic AI response patterns:
   - Response with greeting emoji (wave)
   - Response with thinking emoji
   - Response with multiple emojis throughout
   - Weather-related response with emoji

Use pytest.mark.parametrize with ids parameter for readable test output.

Note: Acknowledge in docstring that double spaces may occur when emoji is removed mid-sentence (e.g., "Hello \U0001F600 World" -> "Hello  World"). This is expected behavior - document it, don't try to fix.
  </action>
  <verify>pytest tests/test_conversation_emoji.py -v shows all tests passing</verify>
  <done>Emoji stripping tests cover normal text, emoji removal, edge cases, and real-world patterns</done>
</task>

</tasks>

<verification>
1. Run: `pytest tests/test_conversation_emoji.py -v`
   - All tests pass
2. Run: `pytest tests/test_conversation_emoji.py --cov=custom_components.clawd.conversation --cov-report=term-missing`
   - Coverage shows strip_emojis and EMOJI_PATTERN tested
3. Verify edge cases documented:
   - Empty string handling
   - Whitespace handling
   - Double-space behavior noted
</verification>

<success_criteria>
- test_conversation_emoji.py exists with 7 test classes
- All tests pass: `pytest tests/test_conversation_emoji.py -v`
- Normal text preserved, emojis removed, edge cases handled
- Text emoticons (:), ;), etc.) preserved
- Non-ASCII Unicode text preserved
- Requirement UNIT-03 satisfied
</success_criteria>

<output>
After completion, create `.planning/phases/02-simple-unit-tests/02-02-SUMMARY.md`
</output>
