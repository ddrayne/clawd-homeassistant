# Codebase Structure

**Analysis Date:** 2026-01-25

## Directory Layout

```
clawd-homeassistant/
├── custom_components/
│   └── clawd/              # Home Assistant custom integration component
│       ├── __init__.py     # Integration lifecycle (setup/unload/reload)
│       ├── conversation.py # Conversation entity implementation
│       ├── config_flow.py  # Configuration UI and validation
│       ├── gateway_client.py # High-level Gateway API client
│       ├── gateway.py      # Low-level WebSocket protocol
│       ├── const.py        # Constants and configuration defaults
│       ├── exceptions.py   # Custom exception hierarchy
│       ├── manifest.json   # Integration metadata
│       ├── strings.json    # User-facing strings for UI
│       ├── icon.png        # Integration icon (128x128)
│       ├── icon@2x.png     # Integration icon (256x256)
│       └── translations/   # Internationalization files
│           └── en.json     # English translations
├── .planning/              # GSD planning documents (auto-generated)
├── README.md               # User documentation and setup guide
├── LICENSE                 # Apache License 2.0
└── hacs.json              # HACS repository metadata
```

## Directory Purposes

**custom_components/clawd/:**
- Purpose: Home Assistant custom integration - all integration code lives here
- Contains: Python modules, configuration, assets, translations
- Key files: `__init__.py` (entry point), `conversation.py` (entity), `gateway_client.py` (API)

**custom_components/clawd/translations/:**
- Purpose: Internationalization support (currently English only)
- Contains: JSON translation files for config flow UI strings
- Key files: `en.json` (English strings)

**.planning/:**
- Purpose: GSD (Generate, Structure, Deploy) planning documents
- Contains: Architecture analysis, concerns, conventions, testing patterns
- Generated by: /gsd:map-codebase commands (do not edit manually)

## Key File Locations

**Entry Points:**

- `custom_components/clawd/__init__.py`: Integration lifecycle entry point
  - `async_setup_entry()`: Called when config entry created (instantiates client, connects, forwards to conversation platform)
  - `async_unload_entry()`: Called when config entry removed (disconnects, cleans up)
  - `async_reload_entry()`: Called on configuration change (unload then setup)

- `custom_components/clawd/config_flow.py`: Configuration entry point
  - `ClawdConfigFlow.async_step_user()`: Initial setup step collecting host/port/token/options
  - `ClawdOptionsFlowHandler.async_step_init()`: Options update (allows changing connection after setup)

**Configuration:**

- `custom_components/clawd/const.py`: All configuration constants
  - Domain name: "clawd"
  - Defaults: host=127.0.0.1, port=18789, timeout=30s, session_key="main", ssl=false
  - Protocol: min/max version=3, client identification strings
  - Config keys: CONF_HOST, CONF_PORT, CONF_TOKEN, CONF_USE_SSL, CONF_TIMEOUT, CONF_SESSION_KEY, CONF_STRIP_EMOJIS

- `custom_components/clawd/manifest.json`: Integration metadata
  - Domain: "clawd"
  - Version: 1.0.1
  - Dependencies: websockets>=12.0
  - Requires Home Assistant 2024.1.0+

**Core Logic:**

- `custom_components/clawd/conversation.py`: Home Assistant conversation entity
  - `ClawdConversationEntity`: Main entity class (extends conversation.ConversationEntity)
  - `strip_emojis()`: Utility for cleaning TTS text
  - `async_setup_entry()`: Registers conversation entity with Home Assistant

- `custom_components/clawd/gateway_client.py`: High-level Gateway API
  - `ClawdGatewayClient`: Main client class (request/response API)
  - `AgentRun`: Event buffering tracker for single agent execution
  - Methods: `connect()`, `disconnect()`, `send_agent_request()`, `health()`, `status()`

- `custom_components/clawd/gateway.py`: Low-level WebSocket protocol
  - `GatewayProtocol`: WebSocket implementation with connection management
  - Connection loop with automatic reconnection (5s backoff)
  - Handshake with protocol version negotiation
  - Request/response correlation via UUID
  - Event dispatch to registered handlers

**Error Handling:**

- `custom_components/clawd/exceptions.py`: Exception hierarchy
  - `ClawdError`: Base exception
  - `GatewayConnectionError`: Connection/network failures
  - `GatewayAuthenticationError`: Token validation failures (fatal)
  - `GatewayTimeoutError`: Timeout during request
  - `AgentExecutionError`: Agent execution failure
  - `ProtocolError`: Protocol violations (fatal)

**User Interface:**

- `custom_components/clawd/strings.json`: Configuration UI strings
  - Config step title, description, field labels
  - Error messages (cannot_connect, invalid_auth, timeout, unknown)
  - Options step for updating configuration

## Naming Conventions

**Files:**

- `__init__.py`: Package entry points and lifecycle
- `conversation.py`: Entity implementations (snake_case with topic)
- `gateway_client.py`: Client abstractions (snake_case with topic)
- `gateway.py`: Protocol implementations (snake_case with topic)
- `config_flow.py`: Configuration flows (snake_case with purpose)
- `const.py`: Constants only (uppercase constants in const.py)
- `exceptions.py`: Exception definitions (CamelCase class names)
- `strings.json`: Localization (JSON structure matches Home Assistant conventions)

**Python Classes:**

- `ClawdConversationEntity`: CamelCase, extends Home Assistant entity
- `ClawdGatewayClient`: CamelCase, public client API
- `GatewayProtocol`: CamelCase, protocol implementation
- `AgentRun`: CamelCase, data tracking class
- `ClawdConfigFlow`: CamelCase, configuration flow handler
- `ClawdOptionsFlowHandler`: CamelCase, options flow handler
- All custom exceptions: CamelCase ending with Error

**Constants:**

- `DOMAIN = "clawd"`: Lowercase, underscore-separated (Home Assistant convention)
- `CONF_*`: Configuration key constants (UPPERCASE)
- `DEFAULT_*`: Default value constants (UPPERCASE)
- `STATE_*`: State string constants (UPPERCASE)
- `PROTOCOL_*`: Protocol constant (UPPERCASE)
- `CLIENT_*`: Client identification constants (UPPERCASE)

**Functions:**

- `async_setup_entry()`: Lowercase, snake_case, async prefix (Home Assistant convention)
- `async_unload_entry()`: Lowercase, snake_case, async prefix
- `validate_connection()`: Lowercase, snake_case
- `strip_emojis()`: Lowercase, snake_case, descriptive verb

**Variables:**

- `_logger`: Lowercase, leading underscore for module private
- `user_input`: Lowercase, snake_case
- `gateway_client`: Lowercase, snake_case
- `self._connected`: Lowercase, snake_case, leading underscore for private
- `self._gateway`: Lowercase, snake_case, leading underscore for private

## Where to Add New Code

**New Feature:**
- Primary code: `custom_components/clawd/` - add new module for new major feature
- Tests: Not yet in place; would add `tests/` directory at root with pytest
- Example: If adding multi-gateway support, add `multi_gateway_manager.py`

**New Conversation/Response Processing:**
- Implementation: `custom_components/clawd/conversation.py` - extend ClawdConversationEntity or add processor module
- Example: If adding response caching, extend _async_handle_message() or create separate caching layer

**New Protocol Features:**
- Implementation: `custom_components/clawd/gateway.py` - add new method to GatewayProtocol class
- Example: If adding streaming response support, add new send_streaming_request() method

**New Configuration Options:**
- Add CONF_* constant to `custom_components/clawd/const.py`
- Add field to vol.Schema() in `custom_components/clawd/config_flow.py`
- Add UI string to `custom_components/clawd/strings.json`
- Handle in ClawdGatewayClient.__init__() and usage locations
- Example: For new timeout category, add CONF_AGENT_TIMEOUT, update form schema, update strings

**Utilities & Helpers:**
- Shared helpers: Add to existing module or create `custom_components/clawd/helpers.py`
- Example: Additional emoji/text processing → add to conversation.py or create text_processor.py

**Error Handling:**
- New error conditions: Add exception class to `custom_components/clawd/exceptions.py`
- Example: For rate limiting, add `GatewayRateLimitError(ClawdError)`

## Special Directories

**custom_components/clawd/translations/:**
- Purpose: Internationalization - maps config_flow strings to multiple languages
- Generated: Partially (Home Assistant generates structure, developer provides translations)
- Committed: Yes (checked into source control)
- Note: Currently only `en.json` provided; additional languages can be added following Home Assistant i18n patterns

**.planning/codebase/:**
- Purpose: Analysis documents (auto-generated by /gsd commands)
- Generated: Yes (do not edit manually)
- Committed: Yes (to version control)
- Contents: ARCHITECTURE.md, STRUCTURE.md, CONVENTIONS.md, TESTING.md, CONCERNS.md (as needed)

## Import Patterns

**Home Assistant Imports:**
```python
from homeassistant.core import HomeAssistant
from homeassistant.config_entries import ConfigEntry
from homeassistant.components import conversation
from homeassistant.const import CONF_HOST, CONF_PORT, CONF_TOKEN, CONF_TIMEOUT, Platform
```

**Internal Module Imports:**
```python
from .const import DOMAIN, DEFAULT_TIMEOUT, CONF_SESSION_KEY
from .gateway_client import ClawdGatewayClient
from .gateway import GatewayProtocol
from .exceptions import GatewayConnectionError, GatewayTimeoutError
```

**External Dependencies:**
```python
import websockets
from websockets.client import WebSocketClientProtocol
from websockets.exceptions import ConnectionClosedError
import voluptuous as vol
```

**Standard Library:**
```python
import asyncio
import json
import logging
import uuid
import re
from typing import Any, Callable
```
